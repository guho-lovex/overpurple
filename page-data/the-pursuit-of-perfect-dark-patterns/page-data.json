{"componentChunkName":"component---src-components-blog-post-layout-tsx","path":"/the-pursuit-of-perfect-dark-patterns/","result":{"data":{"site":{"siteMetadata":{"title":"overpurple - A blog by GuHo"}},"markdownRemark":{"id":"01102961-8bfa-554e-9e0e-7d2e91c7399b","excerpt":"我们创建博客，最难的点应该莫过于添加黑暗模式了 在我们添加黑暗模式前，我们需要定一个我们想要的产品的标准。 a. 用户单击切换亮模式和暗模式。 b. 要保存用户的设置，在用户刷新页面后能访问到正确的主题色。 c. 默认根据用户的操作系统设置设置主题，如果没有设置，则默认的是亮模式。 d…","html":"<p>我们创建博客，最难的点应该莫过于添加黑暗模式了</p>\n<p>在我们添加黑暗模式前，我们需要定一个我们想要的产品的标准。</p>\n<p>a. 用户单击切换亮模式和暗模式。</p>\n<p>b. 要保存用户的设置，在用户刷新页面后能访问到正确的主题色。</p>\n<p>c. 默认根据用户的操作系统设置设置主题，如果没有设置，则默认的是亮模式。</p>\n<p>d. 网站不应该在首次刷新加载时闪烁，即存在主题的过渡显示，即使用户选择了默认的颜色主题。</p>\n<p>e. 网站按钮不能有错误的显示状态。</p>\n<p>我们绘制下来如图\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/overpurple.io/static/456b88902916365537192419298a44d2/555cf/snipaste_theme.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.050632911392405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvklEQVR42k2OPW7CUBCEfWAuQMk1IqUhEskB6FJE7ilyA0QSHAknLzxbfn77N4uMg7G0xeqbnZkt3DGflPlUn9TUHcAIbZTwT3yCxdMbNiU2pT2+2vseXU+Hj09muZoNsLsZU8dIvFiusXrG6sUWD9ju4NCc8+zOp6dEkVJ3Cx1IMZcBdL1U39XXsepJM0v4CzHGeA5tkibh96dmYQAiaqaD+ZY0rAYjJiIaRIMIq7IIiVpmhBCaplV4l1Km/gLNOx/QUBdfMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"思维图\"\n        title=\"\"\n        src=\"/overpurple.io/static/456b88902916365537192419298a44d2/f058b/snipaste_theme.png\"\n        srcset=\"/overpurple.io/static/456b88902916365537192419298a44d2/c26ae/snipaste_theme.png 158w,\n/overpurple.io/static/456b88902916365537192419298a44d2/6bdcf/snipaste_theme.png 315w,\n/overpurple.io/static/456b88902916365537192419298a44d2/f058b/snipaste_theme.png 630w,\n/overpurple.io/static/456b88902916365537192419298a44d2/40601/snipaste_theme.png 945w,\n/overpurple.io/static/456b88902916365537192419298a44d2/78612/snipaste_theme.png 1260w,\n/overpurple.io/static/456b88902916365537192419298a44d2/555cf/snipaste_theme.png 1960w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h4 id=\"获取theme的context\" style=\"position:relative;\"><a href=\"#%E8%8E%B7%E5%8F%96theme%E7%9A%84context\" aria-label=\"获取theme的context permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>获取theme的context</h4>\n<p>首先我们添加一个获取/设置theme的state</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>themeMode<span class=\"token punctuation\">,</span> setThemeMode<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>在页面第一次进入时，我们获取下localStorage下的<code class=\"language-text\">themeMode</code>的value，如果存在的话，我们就设置给theme这个state，否则我们就获取系统下的主题模式。</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> localDarkMode <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'themeMode'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>localDarkMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setThemeMode</span><span class=\"token punctuation\">(</span>localDarkMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> isDarkMode <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">matchMedia</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'(prefers-color-scheme: dark)'</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>matches<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setThemeMode</span><span class=\"token punctuation\">(</span>isDarkMode <span class=\"token operator\">?</span> ThemeModeType<span class=\"token punctuation\">.</span>Dark <span class=\"token operator\">:</span> ThemeModeType<span class=\"token punctuation\">.</span>Light<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>然后我们给Provider里再添加一个toggleTheme方法，用于手动改变主题颜色，设置对应的css主题样式, isDarkMode为切换按钮开关的状态。</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">toggleTheme</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>isDakMode<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> newTheme <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>isDakMode <span class=\"token operator\">?</span> ThemeModeType<span class=\"token punctuation\">.</span>Light <span class=\"token operator\">:</span> ThemeModeType<span class=\"token punctuation\">.</span>Dark<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setThemeMode</span><span class=\"token punctuation\">(</span>newTheme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'themeMode'</span><span class=\"token punctuation\">,</span> newTheme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> newTheme<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hasWindow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        window<span class=\"token punctuation\">.</span>__theme <span class=\"token operator\">=</span> newTheme<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这里我们需要注意⚠️：在gatsby ssr构建页面时，window是没办法获取到的（水化），window只能在浏览器环境中获取到，所以我们需要加个类型来判断window是否存在 <code class=\"language-text\">typeof window !== 'undefined'</code>。</p>\n<p>然后，我们把创建好的theme上下文添加至页面结构中，这里我们直接包裹Layout组件就好。</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Layout</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这样theme上下文就成了，我们在组件里调用 <code class=\"language-text\">const { toggleTheme } = useContext(ThemeContext);</code>就可以应用了。</p>\n<h4 id=\"切换主题组件\" style=\"position:relative;\"><a href=\"#%E5%88%87%E6%8D%A2%E4%B8%BB%E9%A2%98%E7%BB%84%E4%BB%B6\" aria-label=\"切换主题组件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>切换主题组件</h4>\n<p>在我们添加好页面获取和设置theme的上下文后，我们需要创建一个切换主题的button，让用户可以单击切换设置亮暗主题。这里我们借助input checkbox组件的checked属性来进行逻辑上的判读。首先我们通过react的<code class=\"language-text\">ref</code>把input checkbox变成一个受控组件，将其他元素的事件代理到input组件上。\n我们的dom结构如下：</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>toggle-switch<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span>\n    <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>inputRef<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>checkbox<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>toggle-switch-checkbox<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">onBlur</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleBlur<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">onFocus</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleFocus<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">aria-label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Switch between Dark and Light mode<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>toggle-switch-label<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>toggle-switch-dark<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>icon<span class=\"token punctuation\">.</span>dark<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>toggle-switch-sun<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>icon<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">className</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">toggle-switch-switch </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>shadowClassName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>我们在父元素上添加click，点击click获取当下点击的input的checked状态，执行上下文的方法toggleTheme，并且判断当前的checked与之前的checked是否相等，执行input的click和focus方法。通过focus方法可以触发input得onFocus和onBlur方法，来给<code class=\"language-text\">toggle-switch-switch</code>加高亮的样式。</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> checkbox <span class=\"token operator\">=</span> inputRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n    onChange<span class=\"token operator\">?.</span><span class=\"token punctuation\">(</span>checkbox<span class=\"token operator\">?.</span>checked<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    preCheckbox<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>checkbox<span class=\"token operator\">?.</span>checked<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>preCheckbox<span class=\"token punctuation\">.</span>current <span class=\"token operator\">===</span> checkbox<span class=\"token operator\">?.</span>checked<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      checkbox<span class=\"token operator\">?.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      checkbox<span class=\"token operator\">?.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"修复页面刷新出现主题闪烁过渡\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E5%A4%8D%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E5%87%BA%E7%8E%B0%E4%B8%BB%E9%A2%98%E9%97%AA%E7%83%81%E8%BF%87%E6%B8%A1\" aria-label=\"修复页面刷新出现主题闪烁过渡 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修复页面刷新出现主题闪烁过渡</h4>\n<p>现在我们页面基本可以进行亮暗主题的切换了。但是随之而来的问题就是在gatsby中，，第一次渲染不会发生在用户的设备中，当react页面首次执行时，我们无法知道用户的颜色偏好是什么，所以会默认为light, 然后react在客户端重新rehydrate水化后将其替换掉，导致页面会刷新会出现由亮至黑的闪烁。\n我们真正想要的是，我们在给用户发送html的时候就应该有正确的颜色了。\n所以在当我们编译生成页面的html时，在我们内容之前插入一个提前获取颜色的script脚本。</p>\n<blockquote>\n<p>preformance\nIndexedDB 非常适合存储大块数据（我在Beatmapper中使用它来存储数兆字节的二进制文件！）。对于短字符串，localStorage 是完美的💯</p>\n</blockquote>\n<h5 id=\"第一种-利用gatsby构建过程中的暴露方法-在gatsby中更新html\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%B8%80%E7%A7%8D-%E5%88%A9%E7%94%A8gatsby%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95-%E5%9C%A8gatsby%E4%B8%AD%E6%9B%B4%E6%96%B0html\" aria-label=\"第一种 利用gatsby构建过程中的暴露方法 在gatsby中更新html permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第一种： 利用gatsby构建过程中的暴露方法 在gatsby中更新html</h5>\n<p>当gatsby构建时会为我们的网站的每个页面生成一个html文件，我们需要在该内容之上注入一个script脚本，以便浏览器能先解析它。\n在<code class=\"language-text\">gatsby-ssr.tsx</code>中添加 <code class=\"language-text\">setPreBodyComponents</code>方法。这里的onRenderBody方法</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onRenderBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> setPreBodyComponents <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setPreBodyComponents</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MagicScriptTag</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><code class=\"language-text\">MagicScriptTag</code>就是我们添加的script脚本组件，判断浏览器储存的主题色，给body加上亮模式样式或暗模式样式，具体代码:<a href=\"https://github.com/guho-lovex/overpurple.io/blob/master/gatsby-ssr.tsx\">gatsby.ssr.tsx</a>\n并且我们在脚本中注入了一个全局方法, 在浏览器控制台直接可以 <code class=\"language-text\">window.__setThemeMode('dark')</code>来切换暗模式.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">setTheme</span><span class=\"token punctuation\">(</span>newTheme<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>__theme <span class=\"token operator\">=</span> newTheme\n    preferredTheme <span class=\"token operator\">=</span> newTheme\n    document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> newTheme\n  <span class=\"token punctuation\">}</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">__setThemeMode</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>newTheme<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTheme</span><span class=\"token punctuation\">(</span>newTheme<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'themeMode'</span><span class=\"token punctuation\">,</span> newTheme<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>请记住初始渲染发生在编译云中，因此最开始的themeMode一定是undefined，每个用户都会获得相同的HTML，这个html的复选框开始将始终未选中。我们最好的办法是推迟渲染切换，判断获取的themeMode不存在时就返回null，直到React应用程序知道themeMode是什么颜色。\n这里我们的脚本通过<code class=\"language-text\">terser</code>包来进行压缩。</p>\n<blockquote>\n<p>注意⚠️： terser的版本要小于5.x,因为5.x及以上的版本的获取压缩后的code方法不一样。详情见：<a href=\"https://github.com/terser/terser\">https://github.com/terser/terser</a></p>\n</blockquote>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 4.6.11</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> minify <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'terser'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> minifyJsCode <span class=\"token operator\">=</span> <span class=\"token function\">minify</span><span class=\"token punctuation\">(</span>themeScript<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">;</span></code></pre></div>\n<h5 id=\"第二种自定义-htmljs\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E8%87%AA%E5%AE%9A%E4%B9%89-htmljs\" aria-label=\"第二种自定义 htmljs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第二种：自定义 html.js</h5>\n<p>不使用 gatsby-ssr.js 中的 api, 可以自己创建一个自定义 html.js 文件。<a href=\"https://www.gatsbyjs.com/docs/custom-html/\">Customizing html.js</a>\ngatsby使用react组件来处理gatsby core应用程序外部HTML的<code class=\"language-text\">&lt;head></code>和其他部分。大多数站点使用gatsby附带默认的 html.js。</p>\n<p>如果需要自定义站点的html.js，运行一下命令将默认的html.js复制到源代码中，然后根据需要进行修改：</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"node\"><pre class=\"language-node\"><code class=\"language-node\">cp .cache/default-html.js src/html.js</code></pre></div>\n<blockquote>\n<p>当在 gatsby-ssr.js 中无法使用适当的 API 时，自定义 html.js 是一种变通解决方案。考虑使用 onRenderBody 或 onPreRenderHTML 代替上述</p>\n</blockquote>\n<p>如果您看到此错误：Uncaught Error: _registerComponent(...): Target container is not a DOM element。这意味着您的 html.js 缺少所需的“目标容器”。在你的 <code class=\"language-text\">&lt;body></code> 中，你必须有一个 id 为 <code class=\"language-text\">___gatsby</code> 的 div，例如：\nsrc/html.js中</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n  <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">body</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>___gatsby<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">dangerouslySetInnerHTML</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> __html<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>body <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>自定义javascript, 将我们的获取颜色设置颜色的脚本，放进<code class=\"language-text\">__html</code>中。</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span>script\n  dangerouslySetInnerHTML<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">__html</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n      var name = 'world';\n      console.log('Hello ' + name);\n    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>","frontmatter":{"title":"The Pursuit of Perfect Dark Patterns","date":"March 24, 2023","description":"The groping for theme switching of gatsby"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E8%8E%B7%E5%8F%96theme%E7%9A%84context\">获取theme的context</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%88%87%E6%8D%A2%E4%B8%BB%E9%A2%98%E7%BB%84%E4%BB%B6\">切换主题组件</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BF%AE%E5%A4%8D%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E5%87%BA%E7%8E%B0%E4%B8%BB%E9%A2%98%E9%97%AA%E7%83%81%E8%BF%87%E6%B8%A1\">修复页面刷新出现主题闪烁过渡</a></p>\n<ul>\n<li><a href=\"#%E7%AC%AC%E4%B8%80%E7%A7%8D-%E5%88%A9%E7%94%A8gatsby%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95-%E5%9C%A8gatsby%E4%B8%AD%E6%9B%B4%E6%96%B0html\">第一种： 利用gatsby构建过程中的暴露方法 在gatsby中更新html</a></li>\n<li><a href=\"#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E8%87%AA%E5%AE%9A%E4%B9%89-htmljs\">第二种：自定义 html.js</a></li>\n</ul>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/about-building-this-blog/"},"frontmatter":{"title":"About building this blog"}},"next":{"fields":{"slug":"/new-beginnings/"},"frontmatter":{"title":"New Beginnings"}}},"pageContext":{"id":"01102961-8bfa-554e-9e0e-7d2e91c7399b","previousPostId":"7b0c4f45-30b2-56f1-82a9-da7205138fc2","nextPostId":"1fb52d09-8603-5bab-9fd6-a8dfc82d4d3a"}},"staticQueryHashes":["2787180309","3666494887"],"slicesMap":{}}